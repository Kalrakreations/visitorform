<!doctype html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VBook — Visitor Form</title>

  <!-- dynamic theme color for mobile browsers -->
  <meta name="theme-color" content="#f5f5f5">

  <!-- ====================
       INLINE CSS (all in one)
       ==================== -->
  <style>
    /* =========================================================================
       THEME VARIABLES & RESET
       ========================================================================= */
    :root {
      --bg: #f5f7fa;
      --form-bg: #ffffff;
      --text: #222;
      --muted: #8f96a0;
      --primary: #007bff;
      --success: #28a745;
      --danger: #ff4d4d;
      --glass-light: rgba(255,255,255,0.6);
      --glass-dark: rgba(30,30,30,0.55);
      --shadow: 0 8px 20px rgba(0,0,0,0.08);
      --header-height: 64px;

      --toggle-width: 52px;
      --toggle-height: 28px;
      --toggle-knob-size: 22px;

      /* for scroll-light overlay */
      --light-x: 50vw;
      --light-y: 30vh;
    }
    [data-theme="dark"] {
      --bg: #0f1112;
      --form-bg: #131516;
      --text: #f1f1f1;
      --muted: #a6a6a6;
      --primary: #66aaff;
      --shadow: 0 8px 30px rgba(0,0,0,0.6);
      --glass-light: rgba(255,255,255,0.04);
      --glass-dark: rgba(20,20,20,0.6);
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0; padding: 0;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: "Inter", "Segoe UI", Roboto, system-ui, -apple-system, "Poppins", sans-serif;
      background: linear-gradient(180deg, var(--bg), #e9eef6 140%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 18px;
      transition: background .35s ease, color .35s ease;
      position: relative; /* for light overlay */
      overflow-x: hidden;
    }

    /* =========================================================================
       SCROLL-RESPONSIVE LIGHT OVERLAY
       ========================================================================= */
    .light-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      background: radial-gradient(
        circle at var(--light-x) var(--light-y),
        rgba(255,255,255,0.08),
        transparent 60%
      );
      mix-blend-mode: overlay;
      transition: background-position .1s ease;
      z-index: 5;
    }

    /* =========================================================================
       IOS-STYLE GLASS HEADER
       ========================================================================= */
    .site-header {
      position: sticky;
      top: 12px;
      width: calc(100% - 36px);
      max-width: 1100px;
      height: var(--header-height);
      margin: 0 auto 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      background: var(--glass-light);
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.45);
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
      backdrop-filter: blur(10px) saturate(150%);
      -webkit-backdrop-filter: blur(10px) saturate(150%);
      transition: background .35s ease, box-shadow .35s ease;
      z-index: 40;
    }
    [data-theme="dark"] .site-header {
      background: var(--glass-dark);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
    }
    .header-left p {
      font-weight: 600;
      color: var(--text);
      font-size: 16px;
    }
    .header-left a {
      color: inherit;
      text-decoration: none;
      font-weight: 700;
    }

    /* =========================================================================
       THEME TOGGLE (APPLE SWITCH + SUN/MOON ANIMATION)
       ========================================================================= */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      z-index: 41;
    }
    .theme-icon {
      width: 18px; height: 18px;
      opacity: .9;
      transition: transform .42s cubic-bezier(.22,.9,.38,1), opacity .32s ease;
      color: #9aa0a6;
    }
    .theme-toggle input[type="checkbox"] {
      display: none;
    }
    .switch {
      width: var(--toggle-width);
      height: var(--toggle-height);
      background: #d0d5dd;
      border-radius: 999px;
      position: relative;
      cursor: pointer;
      transition: background .25s ease;
    }
    .switch::after {
      content: "";
      position: absolute;
      top: 3px; left: 3px;
      width: var(--toggle-knob-size);
      height: var(--toggle-knob-size);
      background: #fff;
      border-radius: 50%;
      box-shadow: 0 3px 10px rgba(0,0,0,0.12);
      transition: transform .35s cubic-bezier(.2,.9,.35,1);
    }
    .theme-toggle input:checked + .switch {
      background: rgba(255,255,255,0.12);
    }
    .theme-toggle input:checked + .switch::after {
      transform: translateX(calc(var(--toggle-width) - var(--toggle-knob-size) - 6px));
    }

    /* =========================================================================
       FORM WRAPPER & HEAD
       ========================================================================= */
    .form-wrap {
      width: 100%;
      max-width: 1100px;
      background: var(--form-bg);
      border-radius: 14px;
      padding: 26px;
      box-shadow: var(--shadow);
      transition: background .35s ease, box-shadow .35s ease;
      margin-bottom: 60px;
      position: relative;
      z-index: 1;
    }
    [data-theme="dark"] .form-wrap {
      box-shadow: 0 18px 40px rgba(0,0,0,0.5);
    }
    .form-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }
    .form-head h1 {
      font-size: 22px;
      color: var(--text);
      margin: 0;
    }
    .form-sub {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }

    /* =========================================================================
       GRID LAYOUT FOR FIELDS
       ========================================================================= */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px 18px;
    }
    @media (max-width: 820px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    /* =========================================================================
       INPUT CONTAINERS & FLOATING LABELS
       ========================================================================= */
    .input-container {
      position: relative;
    }
    .input-container input,
    .input-container select,
    .input-container textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.12);
      background: transparent;
      font-size: 15px;
      color: var(--text);
      outline: none;
      transition: border-color .22s ease, box-shadow .22s ease, background .22s ease;
    }
    .input-container select {
      appearance: none;
      padding-right: 36px;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 20px) calc(1em + 2px),
        calc(100% - 15px) calc(1em + 2px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }
    .input-container label {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
      font-size: 15px;
      background: transparent;
      padding: 0 6px;
      pointer-events: none;
      transition: all .22s ease;
    }
    .input-container.filled label,
    .input-container input:focus + label,
    .input-container select:focus + label,
    .input-container textarea:focus + label {
      top: -10px;
      font-size: 12px;
      color: var(--primary);
      background: var(--form-bg);
      left: 12px;
    }
    .input-container.filled select {
      border-color: var(--primary);
      box-shadow: 0 6px 18px rgba(0,123,255,0.06);
    }

    /* =========================================================================
       HIDE DROPDOWN LABELS FOR SPECIFIC FIELDS
       ========================================================================= */
    #ic-city   label,
    #ic-state  label,
    #ic-business label,
    #ic-designation label {
      display: none;
    }

    /* =========================================================================
       PLACEHOLDER & FOCUS STYLES
       ========================================================================= */
    ::placeholder {
      color: rgba(0,0,0,0.26);
      transition: color .2s ease;
    }
    [data-theme="dark"] ::placeholder {
      color: rgba(255,255,255,0.18);
    }
    .input-container input:focus,
    .input-container select:focus,
    .input-container textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 6px 18px rgba(0,123,255,0.08);
    }

    /* =========================================================================
       VALID/INVALID STATES & PHONE SPECIAL
       ========================================================================= */
    .input-container.valid input,
    .input-container.valid select,
    .input-container.valid textarea {
      border-color: var(--success) !important;
      box-shadow: 0 8px 22px rgba(40,167,69,0.12);
    }
    .input-container.invalid input,
    .input-container.invalid select,
    .input-container.invalid textarea {
      border-color: var(--danger) !important;
      box-shadow: 0 8px 22px rgba(255,77,77,0.12);
    }
    .input-container.phone-focus input:focus {
      border-color: var(--primary);
      box-shadow: 0 8px 26px rgba(0,123,255,0.12);
    }

    /* =========================================================================
       TEXTAREA, FILE, BUTTON, TOAST, RESPONSIVE TWEAKS
       ========================================================================= */
    textarea {
      min-height: 86px;
      resize: vertical;
    }
    input[type="file"] {
      font-size: 13px;
      padding: 8px;
    }
    .actions {
      margin-top: 18px;
      display: flex;
      gap: 14px;
      align-items: center;
    }
    button.submit-btn {
      position: relative;
      overflow: hidden;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--primary), #0056d6);
      color: white;
      font-weight: 700;
      cursor: pointer;
      min-width: 160px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      transition: transform .18s ease, box-shadow .2s ease, background .28s ease;
    }
    button.submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    button[disabled] {
      opacity: .65;
      cursor: not-allowed;
      transform: none;
    }
    .toast {
      position: fixed;
      right: 18px;
      bottom: 24px;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      display: none;
      z-index: 9999;
    }
    .toast.show {
      display: block;
      animation: toastIn .28s ease;
    }
    @keyframes toastIn {
      from { transform: translateY(8px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @media (max-width: 560px) {
      body { padding: 12px; }
      .site-header { width: calc(100% - 24px); margin-bottom: 18px; }
      .form-wrap { padding: 18px; }
    }
  </style>
</head>
<body>

  <!-- scroll-responsive light overlay -->
  <div class="light-overlay"></div>

  <!-- iOS glass header with toggle -->
  <header class="site-header" role="banner">
    <div class="header-left">
      <p>
        <a href="https://www.linkedin.com/in/skalra1999/" target="_blank" rel="noopener noreferrer">
          Sahil Kalra
        </a>
        &nbsp;|&nbsp;<span class="muted">+91 9646290118</span>
      </p>
    </div>
    <div class="theme-toggle" title="Toggle theme">
      <span id="iconSun" class="theme-icon" title="Light mode">
        <!-- SVG sun -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="#9aa0a6" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"
             xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="3"></circle>
          <path d="M12 1v2M12 21v2M4.2 4.2l1.4 1.4
                   M18.4 18.4l1.4 1.4M1 12h2M21 12h2
                   M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/>
        </svg>
      </span>
      <input id="themeToggleCheckbox" type="checkbox" aria-label="Toggle dark mode">
      <label for="themeToggleCheckbox" class="switch" role="switch" aria-checked="false"></label>
      <span id="iconMoon" class="theme-icon" title="Dark mode">
        <!-- SVG moon -->
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"
             stroke="#9aa0a6" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"
             xmlns="http://www.w3.org/2000/svg">
          <path d="M21 12.79A9 9 0 1111.21 3
                   A7 7 0 0021 12.79z"/>
        </svg>
      </span>
    </div>
  </header>

  <!-- main visitor form -->
  <main class="form-wrap" role="main">
    <div class="form-head">
      <div>
        <h1>Visitor Form</h1>
        <div class="form-sub muted">
          Fill visitor details — offline-capable, phone validation, theme aware
        </div>
      </div>
    </div>

    <form id="visitorForm" autocomplete="off" novalidate>
      <div class="grid">
        <!-- Event Name -->
        <div class="input-container" id="ic-event">
          <input id="eventName" name="eventName" type="text" placeholder=" " />
          <label for="eventName">Event Name</label>
        </div>

        <!-- Name -->
        <div class="input-container" id="ic-name">
          <input id="name" name="name" type="text" placeholder=" " required />
          <label for="name">Name *</label>
        </div>

        <!-- Phone -->
        <div class="input-container" id="ic-phone">
          <input id="phone" name="phone" type="tel" placeholder=" " inputmode="tel" />
          <label for="phone">Phone *</label>
          <div class="muted" style="font-size:12px; margin-top:6px;">
            If India is selected, phone must be 10 digits.
          </div>
        </div>

        <!-- Email -->
        <div class="input-container" id="ic-email">
          <input id="email" name="email" type="email" placeholder=" " />
          <label for="email">Email</label>
        </div>

        <!-- Company -->
        <div class="input-container" id="ic-company">
          <input id="company" name="company" type="text" placeholder=" " />
          <label for="company">Company</label>
        </div>

        <!-- Designation (no label shown) -->
        <div class="input-container" id="ic-designation">
          <select id="designation" name="designation">
            <option value="">Select Designation</option>
            <option>Executive</option>
            <option>Manager</option>
            <option>CEO</option>
            <option>Founder</option>
            <option>Other</option>
          </select>
          <input id="designationOther" name="designationOther"
                 type="text" placeholder="Enter designation"
                 style="display:none; margin-top:8px;" />
        </div>

        <!-- Country -->
        <div class="input-container" id="ic-country">
          <select id="country" name="country">
            <!-- JS populates and defaults to India -->
          </select>
          <label for="country">Country</label>
          <input id="countryOther" name="countryOther"
                 type="text" placeholder="Enter Country"
                 style="display:none; margin-top:8px;" />
        </div>

        <!-- State (no label shown) -->
        <div class="input-container" id="ic-state">
          <select id="state" name="state">
            <option value="">Select State</option>
          </select>
          <input id="stateOther" name="stateOther"
                 type="text" placeholder="Enter State"
                 style="display:none; margin-top:8px;" />
        </div>

        <!-- City (no label shown) -->
        <div class="input-container" id="ic-city">
          <select id="city" name="city">
            <option value="">Select City</option>
          </select>
          <input id="cityOther" name="cityOther"
                 type="text" placeholder="Enter City"
                 style="display:none; margin-top:8px;" />
        </div>

        <!-- Business Type (no label shown) -->
        <div class="input-container" id="ic-business">
          <select id="business" name="business">
            <option value="">Select Business</option>
            <option>Employee</option>
            <option>Trader</option>
            <option>Retailer</option>
            <option>Wholesaler</option>
            <option>Distributor</option>
            <option>Exporter</option>
            <option>E-commerce</option>
            <option>Digital Marketing</option>
            <option>Certification Services</option>
            <option>Hotels</option>
            <option>HoReCa</option>
            <option>Quality</option>
            <option>Marketing</option>
            <option>Other</option>
          </select>
          <input id="businessOther" name="businessOther"
                 type="text" placeholder="Enter business type"
                 style="display:none; margin-top:8px;" />
        </div>

        <!-- Department (auto-filled) -->
        <div class="input-container">
          <input id="department" name="department"
                 type="text" placeholder=" " readonly />
          <label for="department">Assigned Department</label>
        </div>

        <!-- Assigned Person (auto-filled) -->
        <div class="input-container">
          <input id="assignedPerson" name="assignedPerson"
                 type="text" placeholder=" " readonly />
          <label for="assignedPerson">Assigned Person</label>
        </div>

        <!-- Visiting Card Front/Back -->
        <div class="input-container">
          <input id="vcFront" name="vcFront" type="file" accept="image/*" />
          <label for="vcFront">Visiting Card (Front)</label>
        </div>
        <div class="input-container">
          <input id="vcBack" name="vcBack" type="file" accept="image/*" />
          <label for="vcBack">Visiting Card (Back)</label>
        </div>

        <!-- Remarks -->
        <div class="input-container full" id="ic-remarks">
          <textarea id="remarks" name="remarks" placeholder=" "></textarea>
          <label for="remarks">Remarks / Comments</label>
        </div>

        <!-- Hidden geo inputs -->
        <input type="hidden" id="latitude" name="latitude" />
        <input type="hidden" id="longitude" name="longitude" />
      </div>

      <!-- Terms + Submit -->
      <p class="terms muted">
        By continuing to use Copilot, you agree to the
        <a href="#">Terms of Use</a>. See our
        <a href="#">Privacy Statement</a>.
      </p>
      <div class="actions">
        <button id="submitBtn" type="submit" class="submit-btn" aria-live="polite">
          <span id="submitText">Submit</span>
        </button>
        <div class="muted" style="align-self:center;">
          Auto-capture location & offline queue supported
        </div>
      </div>
    </form>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- ====================
       INLINE JS (all in one)
       ==================== -->
  <script>
    (function(){
      'use strict';

      /* CONFIG & ELEMENT REFS */
      const WEBAPP_URL = 'https://script.google.com/macros/s/…/exec';
      const LS_LAST_HASH  = 'vbook_last_submission_hash_v1';
      const LS_OFFLINE_Q  = 'vbook_offline_queue_v1';

      const doc               = document;
      const form              = doc.getElementById('visitorForm');
      const submitBtn         = doc.getElementById('submitBtn');
      const submitText        = doc.getElementById('submitText');
      const toast             = doc.getElementById('toast');

      const country           = doc.getElementById('country');
      const state             = doc.getElementById('state');
      const city              = doc.getElementById('city');
      const phoneInput        = doc.getElementById('phone');
      const businessInput     = doc.getElementById('business');
      const designationSelect = doc.getElementById('designation');

      const departmentInput      = doc.getElementById('department');
      const assignedPersonInput  = doc.getElementById('assignedPerson');

      const themeToggleCheckbox  = doc.getElementById('themeToggleCheckbox');
      const iconSun              = doc.getElementById('iconSun');
      const iconMoon             = doc.getElementById('iconMoon');

      const countryList  = ["India","United States","United Kingdom","Canada","Australia","Other"];
      const statesAndCities = {
        "Chandigarh": ["Chandigarh","New Chandigarh"],
        "Punjab":     ["Amritsar","Ludhiana","Jalandhar","Patiala","Bathinda"],
        // ... other states omitted for brevity
      };

      /* HELPERS */
      function stableStringify(obj) {
        if (!obj || typeof obj !== 'object') return String(obj);
        const keys = Object.keys(obj).sort();
        const res = {};
        keys.forEach(k => res[k] = obj[k]);
        return JSON.stringify(res);
      }
      function simpleHash(str) {
        let h = 2166136261 >>> 0;
        for (let i=0; i<str.length; i++){
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return (h>>>0).toString(16);
      }
      function showToast(msg, t=2800){
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(()=> toast.classList.remove('show'), t);
      }
      function markFilled(el, yes){
        const c = el.closest('.input-container');
        if (!c) return;
        yes? c.classList.add('filled') : c.classList.remove('filled');
      }
      function applyValidation(el, state){
        const c = el.closest('.input-container');
        if (!c) return;
        c.classList.remove('valid','invalid');
        if (state==='valid') c.classList.add('valid');
        if (state==='invalid') c.classList.add('invalid');
      }
      function readFileAsBase64(input){
        return new Promise(r=>{
          if (!input.files || !input.files[0]) return r(null);
          const f=new FileReader();
          f.onload = ()=> {
            const b64 = f.result.split(',')[1];
            r({base64:b64,name:input.files[0].name});
          };
          f.onerror=()=>r(null);
          f.readAsDataURL(input.files[0]);
        });
      }
      function pushOffline(obj){
        try {
          const q = JSON.parse(localStorage.getItem(LS_OFFLINE_Q)||'[]');
          q.push(obj);
          localStorage.setItem(LS_OFFLINE_Q, JSON.stringify(q));
        } catch(e){}
      }
      async function flushOffline(){
        try {
          let q = JSON.parse(localStorage.getItem(LS_OFFLINE_Q)||'[]');
          for (let i=0; i<q.length; i++){
            const res = await fetch(WEBAPP_URL, {
              method:'POST',
              headers:{'Content-Type':'application/x-www-form-urlencoded'},
              body:new URLSearchParams(q[i])
            });
            const text = await res.text();
            if (text.includes('SUCCESS')){
              q.shift();
              localStorage.setItem(LS_OFFLINE_Q, JSON.stringify(q));
              showToast('Synced queued submission');
            } else break;
          }
        } catch(e){}
      }
      function setBusy(b){ 
        if(b) submitBtn.setAttribute('disabled','');
        else submitBtn.removeAttribute('disabled');
      }

      /* POPULATE COUNTRY/STATE/CITY */
      function populateCountries(){
        country.innerHTML='';
        countryList.forEach(cn=>{
          const opt=document.createElement('option');
          opt.value=cn; opt.textContent=cn;
          if(cn==='India') opt.selected=true;
          country.appendChild(opt);
        });
        markFilled(country,true);
        applyValidation(country, country.value==='India'? 'valid':null);
      }
      function populateStates(){
        state.innerHTML='';
        city.innerHTML='';
        if (country.value==='India'){
          Object.keys(statesAndCities).forEach(st=>{
            const o=document.createElement('option');
            o.value=st; o.textContent=st;
            state.appendChild(o);
          });
          const other=document.createElement('option');
          other.value='Other'; other.textContent='Other';
          state.appendChild(other);
          state.disabled=false;
          city.disabled=false;
        } else {
          state.disabled=true;
          state.innerHTML='<option>--</option>';
          city.disabled=false;
          city.innerHTML='<option>Enter city</option>';
        }
      }
      function populateCities(){
        city.innerHTML='';
        if(country.value==='India' && statesAndCities[state.value]){
          statesAndCities[state.value].forEach(ci=>{
            const o=document.createElement('option');
            o.value=ci; o.textContent=ci;
            city.appendChild(o);
          });
          const other=document.createElement('option');
          other.value='Other'; other.textContent='Other';
          city.appendChild(other);
          city.disabled=false;
        } else if(country.value!=='India'){
          city.disabled=false;
          city.innerHTML='<option>Enter city</option>';
        } else {
          city.disabled=true;
          city.innerHTML='<option>--</option>';
        }
      }

      /* PHONE VALIDATION */
      function validatePhone(){
        const val = phoneInput.value.replace(/\D/g,'');
        const c = phoneInput.closest('.input-container');
        if (country.value==='India'){
          if (!val) c.classList.remove('valid','invalid');
          else if(val.length===10){
            c.classList.add('valid');
            c.classList.remove('invalid');
          } else {
            c.classList.add('invalid');
            c.classList.remove('valid');
          }
        } else {
          c.classList.remove('valid','invalid');
        }
      }

      /* BUSINESS -> DEPARTMENT */
      function assignDept(){
        const val = (businessInput.value||'').toLowerCase();
        let dept='', person='';
        if(val.includes('exporter')||val.includes('certification')){
          dept='B2B'; person='Adhiraj';
        } else if(val.includes('digital')||val.includes('e-commerce')){
          dept='Ecommerce'; person='Sahil';
        } else if(/trader|retailer|wholesaler|distributor/.test(val)){
          dept='General Trade'; person='Amit';
        } else if(val.includes('marketing')){
          dept='Marketing'; person='Arsh';
        } else if(val.includes('quality')){
          dept='Quality'; person='Neha';
        } else if(val.includes('hotel')||val.includes('horeca')){
          dept='Sales'; person='Yogesh';
        }
        departmentInput.value = dept;
        assignedPersonInput.value = person;
        if(dept){
          markFilled(departmentInput,true);
          applyValidation(departmentInput,'valid');
        } else {
          markFilled(departmentInput,false);
          applyValidation(departmentInput,null);
        }
      }

      /* THEME TOGGLE & ICON ANIMATION */
      function setTheme(mode){
        const html = document.documentElement;
        if(mode==='dark'){
          html.setAttribute('data-theme','dark');
          themeToggleCheckbox.checked=true;
          iconSun.style.transform='rotate(-60deg) scale(.8)';
          iconSun.style.opacity='0';
          iconMoon.style.transform='rotate(0deg) scale(1)';
          iconMoon.style.opacity='1';
          document.querySelector('meta[name="theme-color"]').setAttribute('content','#0f1112');
        } else {
          html.setAttribute('data-theme','light');
          themeToggleCheckbox.checked=false;
          iconSun.style.transform='rotate(0) scale(1)';
          iconSun.style.opacity='1';
          iconMoon.style.transform='rotate(60deg) scale(.8)';
          iconMoon.style.opacity='0';
          document.querySelector('meta[name="theme-color"]').setAttribute('content','#f5f5f5');
        }
        localStorage.setItem('vbook_theme', mode);
        if(navigator.vibrate) navigator.vibrate(15);
      }

      /* DUPLICATE SUBMISSION PREVENTION */
      function isDuplicate(obj){
        const s=stableStringify(obj),
              h=simpleHash(s),
              last=localStorage.getItem(LS_LAST_HASH);
        return last===h;
      }
      function markHash(obj){
        const s=stableStringify(obj),
              h=simpleHash(s);
        localStorage.setItem(LS_LAST_HASH, h);
      }

      /* SUBMIT HANDLER */
      async function handleSubmit(e){
        e.preventDefault();

        // phone check
        if(country.value==='India'){
          const d=phoneInput.value.replace(/\D/g,'');
          if(d.length!==10){
            applyValidation(phoneInput,'invalid');
            phoneInput.focus();
            return showToast('Phone must be 10 digits for India');
          }
        }

        // collect values
        const data={};
        Array.from(form.elements).forEach(el=>{
          if(!el.name||el.type==='file') return;
          data[el.name]=el.value||'';
        });

        if(isDuplicate(data)){
          return showToast('Duplicate submission prevented');
        }
        data._clientTimestamp = new Date().toISOString();

        // busy UI
        setBusy(true);
        submitText.textContent='Submitting...';

        // attach files
        const f1=await readFileAsBase64(doc.getElementById('vcFront'));
        const f2=await readFileAsBase64(doc.getElementById('vcBack'));
        if(f1){ data.vcFrontBase64=f1.base64; data.vcFrontName=f1.name }
        if(f2){ data.vcBackBase64=f2.base64; data.vcBackName=f2.name }

        // offline queue
        if(!navigator.onLine){
          pushOffline
